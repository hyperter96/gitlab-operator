external_url "#{ENV['GITLAB_EXTERNAL_URL']}"

root_pass = ENV['GITLAB_ROOT_PASSWORD']
gitlab_rails['initial_root_password'] = root_pass unless root_pass.to_s == '';
nginx['enable'] = false
registry_nginx['enable'] = false
mattermost_nginx['enable'] = false

gitlab_workhorse['listen_network'] = 'tcp'
gitlab_workhorse['listen_addr'] = '0.0.0.0:8005'

postgresql['enable'] = false
gitlab_rails['db_host'] = ENV['POSTGRES_HOST']
gitlab_rails['db_password'] = "#{ENV['POSTGRES_PASSWORD']}"
gitlab_rails['db_username'] = ENV['POSTGRES_USER']
gitlab_rails['db_database'] = ENV['POSTGRES_DB']
gitlab_rails['initial_shared_runners_registration_token'] = "#{ENV['GITLAB_SHARED_RUNNERS_REGISTRATION_TOKEN']}"

redis['enable'] = false
gitlab_rails['redis_host'] = ENV['REDIS_HOST']
gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD']

manage_accounts['enable'] = true
manage_storage_directories['manage_etc'] = false

gitlab_shell['auth_file'] = '/gitlab-data/ssh/authorized_keys'
git_data_dirs({'default' => {'path' => '/gitlab-data/git-data'}}) 
gitlab_rails['shared_path'] = '/gitlab-data/shared'
gitlab_rails['uploads_directory'] = '/gitlab-data/uploads'
gitlab_ci['builds_directory'] = '/gitlab-data/builds'
gitlab_rails['trusted_proxies'] = ["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16"]

postgres_exporter['enable'] = true
postgres_exporter['env'] = {
    'DATA_SOURCE_NAME' => "user=#{ENV['POSTGRES_USER']} host=#{ENV['POSTGRES_HOST']} port=5432 dbname=#{ENV['POSTGRES_DB']} password=#{ENV['POSTGRES_PASSWORD']} sslmode=disable"
}
redis_exporter['enable'] = true
redis_exporter['flags'] = {
    'redis.addr' => "#{ENV['REDIS_HOST']}:6379",
    'redis.password' => "#{ENV['REDIS_PASSWORD']}"
}

registry['enable'] = {{ .RegistryEnabled }}
{{ if .RegistryEnabled }}
registry_external_url '{{ .RegistryExternalURL }}'
registry['registry_http_addr'] = '0.0.0.0:8105'
registry['dir'] = '/gitlab-registry' 
{{ end }}

{{ if .MonitoringWhitelist }}
gitlab_rails['monitoring_whitelist'] = {{ .MonitoringWhitelist }}
{{ end }}

prometheus['enable'] = false
gitlab_exporter['listen_address'] = '0.0.0.0'
gitlab_exporter['listen_port'] = '9168'
redis_exporter['listen_address'] = '0.0.0.0:9121'
postgres_exporter['listen_address'] = '0.0.0.0:9187'
gitaly['prometheus_listen_addr'] = '0.0.0.0:9236'
gitlab_workhorse['prometheus_listen_addr'] = '0.0.0.0:9229'
sidekiq['listen_address'] = '0.0.0.0'
#prometheus['listen_address'] = '0.0.0.0:9090'
#prometheus['monitor_kubernetes'] = false
